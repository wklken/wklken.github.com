<!DOCTYPE html>
<html lang="en">

<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<head>
    <meta name="google-site-verification" content="SzE6WCs23qFevgBzRIuG9vcfLU0lW_Vd5hFT-cJOLBE" />
    <title>Python源码阅读-闭包的实现</title>
    <meta charset="utf-8" />
    <meta name="description" content="">
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

        <link rel="shortcut icon" href="/favicon.ico"/>
        <link rel="stylesheet" href="/theme/css/styles.css" media="all" />
        <link rel="stylesheet" href="/theme/css/monokai.css" media="all" />
        <link rel="stylesheet" href="/theme/css/tab.min.css" media="all" />
        <link rel="stylesheet" href="/theme/css/jquery-ui.min.css" media="all" />

        <link rel="stylesheet" href="/theme/css/font-awesome.min.css">
        <!--
        <link rel="stylesheet" href="http://apps.bdimg.com/libs/fontawesome/4.2.0/css/font-awesome.min.css">
        -->
        <!--[if IE 7]>
            <link rel="stylesheet" href="/theme/css/font-awesome-ie7.min.css">
        <![endif]-->

        <link href="/" type="application/atom+xml" rel="alternate" title="wklken's blog ATOM Feed" />
        <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="wklken's blog RSS Feed" />

</head>

<body>
    <div id="page" class="row">
        <div class="large-9 large-centered columns">

        <header id="header">
            <div class="constraint">
                <div class="o">
                    <a href="/"><h1 class="banner">Wklken <span class="blue"> Building </span></h1></a>

                <div class="social">
                            <a href="https://github.com/wklken" target='_blank'><i class="icon-github-sign icon-2x"></i></a>
                            <a href="http://weibo.com/wklken" target='_blank'><i class="icon-weibo icon-2x"></i></a>
                            <a href="mailto:wklken@yeah.net"><i class="icon-envelope icon-2x"></i></a>
                            <a href="http://www.wklken.me/feed.xml" target='_blank'><i class="icon-rss-sign icon-2x"></i></a>
                </div>
                <div class="nav">
                            <a href="/">首页</a>
                            <a href="/categories.html">分类</a>
                            <a href="/archives.html">归档</a>
                            <a href="/pages/projects.html">项目</a>
                            <a href="/pages/links.html">友链</a>
                            <a href="/pages/aboutme.html">关于</a>

                </div>

                </div>
            </div>
        </header><!-- /#banner -->

        <section id="main">


<article id="article">
    <section id="header">
        <!--
        <div class="meta">2015年09月04日</div>
        <h1 id="title"> Python源码阅读-闭包的实现 </h1>
        -->
        <div class="meta"> &nbsp; </div>
        <h1> Python源码阅读-闭包的实现 </h1>
    </section>

        <section id="toc">
            <div id="toc"><ul><li><a class="toc-href" href="#" title="Python源码阅读-闭包的实现">Python源码阅读-闭包的实现</a><ul><li><a class="toc-href" href="#bi-bao" title="闭包">闭包</a></li><li><a class="toc-href" href="#pycodeobject" title="PyCodeObject">PyCodeObject</a></li><li><a class="toc-href" href="#pycellobject" title="PyCellObject">PyCellObject</a></li><li><a class="toc-href" href="#zhi-de-que-ren-yu-chuan-di-guo-cheng" title="值的确认与传递过程">值的确认与传递过程</a></li><li><a class="toc-href" href="#kan-kan-pyframeobject" title="看看PyFrameObject">看看PyFrameObject</a></li><li><a class="toc-href" href="#shi-li-han-shu-de-f_localsplus" title="示例函数的f_localsplus">示例函数的f_localsplus</a></li><li><a class="toc-href" href="#chuan-di" title="传递">传递</a></li><li><a class="toc-href" href="#ran-hou-zai-qian-tao-han-shu-bei-diao-yong-de-shi-hou" title="然后, 在嵌套函数被调用的时候">然后, 在嵌套函数被调用的时候</a></li><li><a class="toc-href" href="#zui-hou-zai-lai-kan-yi-ge-bi-bao-de-dis" title="最后, 再来看一个闭包的dis">最后, 再来看一个闭包的dis</a></li></ul></li></ul></div>
        </section>
    <section id="content">
        <h3 id="bi-bao">闭包</h3>
<p>e.g.</p>
<div class="monokai"><pre><span></span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_add</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">do_add</span>

<span class="n">add_5</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">print</span> <span class="n">add_5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 6</span>
<span class="k">print</span> <span class="n">add_5</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 7</span>
</pre></div>
<p>需要回答, 什么是闭包, CPython底层是如何实现的?</p>
<h3 id="pycodeobject">PyCodeObject</h3>
<div class="monokai"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
    <span class="kt">int</span> <span class="n">co_argcount</span><span class="p">;</span>        <span class="cm">/* #arguments, except *args */</span>
    <span class="kt">int</span> <span class="n">co_nlocals</span><span class="p">;</span>         <span class="cm">/* #local variables */</span>
    <span class="kt">int</span> <span class="n">co_stacksize</span><span class="p">;</span>       <span class="cm">/* #entries needed for evaluation stack */</span>
    <span class="kt">int</span> <span class="n">co_flags</span><span class="p">;</span>           <span class="cm">/* CO_..., see below */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_code</span><span class="p">;</span>      <span class="cm">/* instruction opcodes */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_consts</span><span class="p">;</span>    <span class="cm">/* list (constants used) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_names</span><span class="p">;</span>     <span class="cm">/* list of strings (names used) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_varnames</span><span class="p">;</span>  <span class="cm">/* tuple of strings (local variable names) */</span>

    <span class="c1">// 保存使用了的外层作用域中的变量名集合 (编译时就知道的! 被嵌套的时候有用)</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_freevars</span><span class="p">;</span>  <span class="cm">/* tuple of strings (free variable names) */</span>
    <span class="c1">// 保存嵌套作用域中使用的变量名集合, (编译时就知道的! 包含嵌套函数时有用)</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_cellvars</span><span class="p">;</span>      <span class="cm">/* tuple of strings (cell variable names) */</span>


    <span class="cm">/* The rest doesn't count for hash/cmp */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_filename</span><span class="p">;</span>  <span class="cm">/* string (where it was loaded from) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_name</span><span class="p">;</span>      <span class="cm">/* string (name, for reference) */</span>
    <span class="kt">int</span> <span class="n">co_firstlineno</span><span class="p">;</span>     <span class="cm">/* first source line number */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_lnotab</span><span class="p">;</span>    <span class="cm">/* string (encoding addr&lt;-&gt;lineno mapping) See</span>
<span class="cm">                   Objects/lnotab_notes.txt for details. */</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">co_zombieframe</span><span class="p">;</span>     <span class="cm">/* for optimization only (see frameobject.c) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_weakreflist</span><span class="p">;</span>   <span class="cm">/* to support weakrefs to code objects */</span>
<span class="p">}</span> <span class="n">PyCodeObject</span><span class="p">;</span>
</pre></div>
<p>我们关注两个, <code>co_freevars</code> 和 <code>co_cellvars</code></p>
<div class="monokai"><pre><span></span>co_freevars, 保存使用了的外层作用域中的变量名集合 (编译时就知道的! 被嵌套的时候有用)

co_cellvars, 保存嵌套作用域中使用的变量名集合, (编译时就知道的! 包含嵌套函数时有用)
</pre></div>
<p>对于我们上面的那个示例, <code>add</code>是外层函数, <code>do_add</code>是嵌套函数, 我们可以通过<code>func_code</code>打印看看</p>
<div class="monokai"><pre><span></span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>    <span class="c1"># 外层函数</span>
    <span class="c1"># 外层函数, 没有使用了外层作用域变量, 被嵌套函数使用了'x'</span>
    <span class="k">print</span> <span class="n">add</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_freevars</span>    <span class="c1"># ()</span>
    <span class="k">print</span> <span class="n">add</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_cellvars</span>    <span class="c1"># ('x',)</span>

    <span class="k">def</span> <span class="nf">do_add</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>  <span class="c1"># 嵌套函数</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">value</span>

    <span class="c1"># 内层函数, 使用了外层作用域便令'x', 没有嵌套函数故嵌套作用域变量名集合空</span>
    <span class="k">print</span> <span class="n">do_add</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_freevars</span> <span class="c1"># ('x',)</span>
    <span class="k">print</span> <span class="n">do_add</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_cellvars</span> <span class="c1"># ()</span>
    <span class="k">return</span> <span class="n">do_add</span>
</pre></div>
<p>此时图示</p>
<p><img alt="closure" src="/imgs/python-source/python-closure.png"/></p>
<p>这时候, 只是记录了使用到的变量名, 标记下是否使用了外层的/被内层使用的变量</p>
<p>具体的值是在运行时确定的, 例如</p>
<div class="monokai"><pre><span></span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
<p>此时<code>x=5</code>, 这个是在<code>add</code>的名字空间里面的, 那么, <code>x=5</code>是怎么传递到嵌套函数内? 嵌套函数又是如何知晓<code>x</code>的值?</p>
<p>记住这两个问题, 然后我们首先来看一个新的数据结构</p>
<h3 id="pycellobject">PyCellObject</h3>
<div class="monokai"><pre><span></span>  <span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">ob_ref</span><span class="p">;</span>   <span class="cm">/* Content of the cell or NULL when empty */</span> <span class="o">=&gt;</span> <span class="err">指向一个</span><span class="n">PyObject</span>
  <span class="p">}</span> <span class="n">PyCellObject</span><span class="p">;</span>


  <span class="n">PyObject</span> <span class="o">*</span>
  <span class="nf">PyCell_New</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">PyCellObject</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>

      <span class="n">op</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyCellObject</span> <span class="o">*</span><span class="p">)</span><span class="n">PyObject_GC_New</span><span class="p">(</span><span class="n">PyCellObject</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PyCell_Type</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
          <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">op</span><span class="o">-&gt;</span><span class="n">ob_ref</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>  <span class="c1">//建立关系</span>
      <span class="n">Py_XINCREF</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

      <span class="n">_PyObject_GC_TRACK</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">op</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
<p>这是个很简单的基本对象, 有一个<code>ob_ref</code>指向另一个<code>PyObject</code>, 仅此而已</p>
<p>图示</p>
<p><img alt="closure" src="/imgs/python-source/python-closure2.png"/></p>
<p>作用呢?</p>
<h3 id="zhi-de-que-ren-yu-chuan-di-guo-cheng">值的确认与传递过程</h3>
<p>调用</p>
<div class="monokai"><pre><span></span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
<p>此时, 开始调用函数</p>
<div class="monokai"><pre><span></span><span class="n">CALL_FUNCTION</span>

<span class="o">=&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">call_function</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="n">oparg</span><span class="p">);</span>

<span class="o">=&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">fast_function</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">pp_stack</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">nk</span><span class="p">);</span>

      <span class="k">return</span> <span class="nf">PyEval_EvalCodeEx</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span>
                               <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">pp_stack</span><span class="p">)</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span>
                               <span class="p">(</span><span class="o">*</span><span class="n">pp_stack</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span>
                               <span class="n">PyFunction_GET_CLOSURE</span><span class="p">(</span><span class="n">func</span><span class="p">));</span>

<span class="o">=&gt;</span>

<span class="n">PyEval_EvalCodeEx</span>

<span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="err">此时其</span><span class="n">co_cellvars</span> <span class="o">=</span> <span class="p">(</span><span class="sc">'x'</span><span class="p">,)</span> <span class="err">非空</span><span class="p">,</span> <span class="err">将会执行的逻辑代码</span>


      <span class="cm">/* Allocate and initialize storage for cell vars, and copy free</span>
<span class="cm">         vars into frame.  This isn't too efficient right now. */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_cellvars</span><span class="p">))</span> <span class="p">{</span>
          <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">nargs</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>
          <span class="kt">char</span> <span class="o">*</span><span class="n">cellname</span><span class="p">,</span> <span class="o">*</span><span class="n">argname</span><span class="p">;</span>
          <span class="n">PyObject</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

          <span class="n">nargs</span> <span class="o">=</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">co_argcount</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_VARARGS</span><span class="p">)</span>
              <span class="n">nargs</span><span class="o">++</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_VARKEYWORDS</span><span class="p">)</span>
              <span class="n">nargs</span><span class="o">++</span><span class="p">;</span>

          <span class="cm">/* Initialize each cell var, taking into account</span>
<span class="cm">             cell vars that are initialized from arguments.</span>

<span class="cm">             Should arrange for the compiler to put cellvars</span>
<span class="cm">             that are arguments at the beginning of the cellvars</span>
<span class="cm">             list so that we can march over it more efficiently?</span>
<span class="cm">          */</span>

          <span class="c1">// for 循环遍历 co_cellvars = ('x', ), i = 0</span>
          <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_cellvars</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>

              <span class="c1">// cellname = 'x'</span>
              <span class="n">cellname</span> <span class="o">=</span> <span class="n">PyString_AS_STRING</span><span class="p">(</span>
                  <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_cellvars</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
              <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

              <span class="c1">// 遍历函数的参数变量, narg=1, j=0</span>
              <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nargs</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

                  <span class="c1">// 访问当前名字空间</span>
                  <span class="n">argname</span> <span class="o">=</span> <span class="n">PyString_AS_STRING</span><span class="p">(</span>
                      <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_varnames</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>

                  <span class="c1">// 匹配上了</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cellname</span><span class="p">,</span> <span class="n">argname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

                      <span class="c1">// new 一个 PyCellObject, ob_ref指向变量的PyObject</span>
                      <span class="n">c</span> <span class="o">=</span> <span class="n">PyCell_New</span><span class="p">(</span><span class="n">GETLOCAL</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
                      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                          <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

                      <span class="c1">// #define GETLOCAL(i)     (fastlocals[i])</span>
                      <span class="c1">// fastlocals = f-&gt;f_localsplus;</span>
                      <span class="c1">// 即 f-&gt;f_localsplus[co-&gt;co_nlocals + i] = c, 相当于放到下一层freevars变量</span>
                      <span class="n">GETLOCAL</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_nlocals</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
                      <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                      <span class="k">break</span><span class="p">;</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="c1">// 没有匹配, 给个指向NULL的PyCellObject, 先New一个对象占位</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">c</span> <span class="o">=</span> <span class="n">PyCell_New</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
                  <span class="n">SETLOCAL</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_nlocals</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span> <span class="c1">//注意内存地址</span>
              <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">}</span>
</pre></div>
<p>逻辑即, 如果发现当前函数<code>co_cellvars</code>非空, 即表示存在被内层函数调用的变量, 那么遍历这个<code>co_cellvars</code>集合, 拿到集合中每个变量名在当前名字空间中的值, 然后放到当前函数的<code>f-&gt;f_localsplus</code>中.</p>
<p>这里, 我们可以知道<code>x=5</code>被放进去了</p>
<p>为什么放到<code>f-&gt;f_localsplus</code>中呢?</p>
<h3 id="kan-kan-pyframeobject">看看PyFrameObject</h3>
<div class="monokai"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_frame</span> <span class="p">{</span>
    <span class="n">PyObject_VAR_HEAD</span>
    <span class="k">struct</span> <span class="n">_frame</span> <span class="o">*</span><span class="n">f_back</span><span class="p">;</span>  <span class="cm">/* previous frame, or NULL */</span>
    <span class="n">PyCodeObject</span> <span class="o">*</span><span class="n">f_code</span><span class="p">;</span>   <span class="cm">/* code segment */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_builtins</span><span class="p">;</span>   <span class="cm">/* builtin symbol table (PyDictObject) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_globals</span><span class="p">;</span>    <span class="cm">/* global symbol table (PyDictObject) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_locals</span><span class="p">;</span>     <span class="cm">/* local symbol table (any mapping) */</span>
    <span class="n">PyObject</span> <span class="o">**</span><span class="n">f_valuestack</span><span class="p">;</span>    <span class="cm">/* points after the last local */</span>
    <span class="cm">/* Next free slot in f_valuestack.  Frame creation sets to f_valuestack.</span>
<span class="cm">       Frame evaluation usually NULLs it, but a frame that yields sets it</span>
<span class="cm">       to the current stack top. */</span>
    <span class="n">PyObject</span> <span class="o">**</span><span class="n">f_stacktop</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_trace</span><span class="p">;</span>      <span class="cm">/* Trace function */</span>

    <span class="cm">/* If an exception is raised in this frame, the next three are used to</span>
<span class="cm">     * record the exception info (if any) originally in the thread state.  See</span>
<span class="cm">     * comments before set_exc_info() -- it's not obvious.</span>
<span class="cm">     * Invariant:  if _type is NULL, then so are _value and _traceback.</span>
<span class="cm">     * Desired invariant:  all three are NULL, or all three are non-NULL.  That</span>
<span class="cm">     * one isn't currently true, but "should be".</span>
<span class="cm">     */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_exc_type</span><span class="p">,</span> <span class="o">*</span><span class="n">f_exc_value</span><span class="p">,</span> <span class="o">*</span><span class="n">f_exc_traceback</span><span class="p">;</span>

    <span class="n">PyThreadState</span> <span class="o">*</span><span class="n">f_tstate</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">f_lasti</span><span class="p">;</span>        <span class="cm">/* Last instruction if called */</span>
    <span class="cm">/* Call PyFrame_GetLineNumber() instead of reading this field</span>
<span class="cm">       directly.  As of 2.3 f_lineno is only valid when tracing is</span>
<span class="cm">       active (i.e. when f_trace is set).  At other times we use</span>
<span class="cm">       PyCode_Addr2Line to calculate the line from the current</span>
<span class="cm">       bytecode index. */</span>
    <span class="kt">int</span> <span class="n">f_lineno</span><span class="p">;</span>       <span class="cm">/* Current line number */</span>
    <span class="kt">int</span> <span class="n">f_iblock</span><span class="p">;</span>       <span class="cm">/* index in f_blockstack */</span>
    <span class="n">PyTryBlock</span> <span class="n">f_blockstack</span><span class="p">[</span><span class="n">CO_MAXBLOCKS</span><span class="p">];</span> <span class="cm">/* for try and loop blocks */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_localsplus</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>  <span class="cm">/* locals+stack, dynamically sized */</span>
<span class="p">}</span> <span class="n">PyFrameObject</span><span class="p">;</span>
</pre></div>
<p>注意<code>f_localsplus</code></p>
<div class="monokai"><pre><span></span>f_localsplus为一个PyObject的指针数组，大小为1。

c语言中, 当申请一个大小超过sizeof(PyFrameObject)的结构体对象时，超过的部分就自动分配给f_localsplus
</pre></div>
<p>创建过程</p>
<p>在<code>call_function</code>的时候, <code>new</code>了一个PyFrameObject</p>
<div class="monokai"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">PyFrame_New</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span> <span class="n">locals</span><span class="p">);</span>

<span class="o">=&gt;</span>

<span class="n">PyFrameObject</span> <span class="o">*</span>
<span class="n">PyFrame_New</span><span class="p">(</span><span class="n">PyThreadState</span> <span class="o">*</span><span class="n">tstate</span><span class="p">,</span> <span class="n">PyCodeObject</span> <span class="o">*</span><span class="n">code</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span><span class="p">,</span>
            <span class="n">PyObject</span> <span class="o">*</span><span class="n">locals</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">Py_ssize_t</span> <span class="n">extras</span><span class="p">,</span> <span class="n">ncells</span><span class="p">,</span> <span class="n">nfrees</span><span class="p">;</span>
        <span class="n">ncells</span> <span class="o">=</span> <span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">co_cellvars</span><span class="p">);</span>
        <span class="n">nfrees</span> <span class="o">=</span> <span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">co_freevars</span><span class="p">);</span>
        <span class="n">extras</span> <span class="o">=</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">co_stacksize</span> <span class="o">+</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">co_nlocals</span> <span class="o">+</span> <span class="n">ncells</span> <span class="o">+</span>
            <span class="n">nfrees</span><span class="p">;</span>

<span class="o">=&gt;</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">PyObject_GC_NewVar</span><span class="p">(</span><span class="n">PyFrameObject</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PyFrame_Type</span><span class="p">,</span> <span class="n">extras</span><span class="p">);</span>
</pre></div>
<p>即</p>
<div class="monokai"><pre><span></span>f_localsplus =&gt; 局部变量 + cell对象 + free对象 + 运行时栈
</pre></div>
<p>原因: 因为函数中的局部变量总是固定不变的, 在编译时就能确定局部变量使用的内存空间的位置, 也能确定访问局部变量的字节码应该如何访问内存, 有了这些信息, Python就能借助静态的方法实现局部变量, 而不是动态查找PyDictObject, 提高执行效率</p>
<p><img alt="closure" src="/imgs/python-source/python-closure3.png"/></p>
<h3 id="shi-li-han-shu-de-f_localsplus">示例函数的f_localsplus</h3>
<p>看一下上面赋值用的宏定义</p>
<div class="monokai"><pre><span></span>  <span class="n">fastlocals</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_localsplus</span><span class="p">;</span>
  <span class="cp">#define GETLOCAL(i)     (fastlocals[i])</span>
  <span class="cp">#define SETLOCAL(i, value)      do { PyObject *tmp = GETLOCAL(i); \</span>
<span class="cp">                                       GETLOCAL(i) = value; \</span>
<span class="cp">                                       Py_XDECREF(tmp); } while (0)</span>
</pre></div>
<p>最终得到</p>
<p><img alt="closure" src="/imgs/python-source/python-closure4.png"/></p>
<p>接下去呢? <code>CALL_FUNCTION</code>最后怎么处理将cell传入嵌套函数?</p>
<h3 id="chuan-di">传递</h3>
<p><code>CALL_FUNCTION</code> 完成<code>new</code>一个<code>PyFrameObject</code>之后,</p>
<p>最终执行这个frame</p>
<div class="monokai"><pre><span></span><span class="n">retval</span> <span class="o">=</span> <span class="n">PyEval_EvalFrameEx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
<p>PyEval_EvalFrameEx</p>
<div class="monokai"><pre><span></span>  <span class="n">PyObject</span> <span class="o">*</span>
  <span class="nf">PyEval_EvalFrameEx</span><span class="p">(</span><span class="n">PyFrameObject</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">throwflag</span><span class="p">)</span>
  <span class="p">{</span>

    <span class="n">fastlocals</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_localsplus</span><span class="p">;</span>
    <span class="n">freevars</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_localsplus</span> <span class="o">+</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">co_nlocals</span><span class="p">;</span>


<span class="o">=&gt;</span> <span class="err">此时涉及</span><span class="n">op_code</span><span class="err">的执行了</span>
</pre></div>
<p>查看一下dis的结果</p>
<div class="monokai"><pre><span></span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_add</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">do_add</span>

  <span class="mi">5</span>           <span class="mi">0</span> <span class="n">LOAD_CLOSURE</span>             <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
              <span class="mi">3</span> <span class="n">BUILD_TUPLE</span>              <span class="mi">1</span>
              <span class="mi">6</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">do_add</span> <span class="n">at</span> <span class="mh">0x10c9cec30</span><span class="p">,</span> <span class="nb">file</span> <span class="s2">"a.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">5</span><span class="o">&gt;</span><span class="p">)</span>
              <span class="mi">9</span> <span class="n">MAKE_CLOSURE</span>             <span class="mi">0</span>
             <span class="mi">12</span> <span class="n">STORE_FAST</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">do_add</span><span class="p">)</span>

  <span class="mi">7</span>          <span class="mi">15</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">do_add</span><span class="p">)</span>
             <span class="mi">18</span> <span class="n">RETURN_VALUE</span>
</pre></div>
<p>首先<code>LOAD_CLOSURE 0</code></p>
<div class="monokai"><pre><span></span>          <span class="k">case</span> <span class="nl">LOAD_CLOSURE</span><span class="p">:</span>
              <span class="n">x</span> <span class="o">=</span> <span class="n">freevars</span><span class="p">[</span><span class="n">oparg</span><span class="p">];</span>
              <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
              <span class="n">PUSH</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
              <span class="k">break</span><span class="p">;</span>

<span class="err">入栈</span><span class="p">,</span> <span class="err">此时得到一个</span><span class="n">PyCellObject</span><span class="p">,</span> <span class="err">指向</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sc">'x'</span>

<span class="n">LOAD_CLOSURE</span> <span class="err">在编译时会根据嵌套函数中</span> <span class="n">co_freevars</span><span class="p">,</span> <span class="err">决定了取得参数位置和个数</span>
</pre></div>
<p>然后, <code>BUILD_TUPLE</code>, 将cell对象打包成tuple, 得到<code>('x', )</code></p>
<p>然后, 开始, 载入嵌套函数<code>do_add</code>, 入栈</p>
<p>调用<code>MAKE_CLOSURE</code></p>
<div class="monokai"><pre><span></span>          <span class="k">case</span> <span class="nl">MAKE_CLOSURE</span><span class="p">:</span>
          <span class="p">{</span>
              <span class="n">v</span> <span class="o">=</span> <span class="n">POP</span><span class="p">();</span> <span class="cm">/* code object */</span>  <span class="c1">// do_add函数</span>
              <span class="n">x</span> <span class="o">=</span> <span class="n">PyFunction_New</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_globals</span><span class="p">);</span> <span class="c1">//绑定global名字空间</span>
              <span class="c1">// 到这里, 得到一个PyFunctionObject</span>

              <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">v</span> <span class="o">=</span> <span class="n">POP</span><span class="p">();</span>   <span class="c1">// 得到tuple, ('x', )</span>

                  <span class="c1">// 注意这里</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">PyFunction_SetClosure</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                      <span class="cm">/* Can't happen unless bytecode is corrupt. */</span>
                      <span class="n">why</span> <span class="o">=</span> <span class="n">WHY_EXCEPTION</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="p">......</span>
          <span class="p">}</span>
</pre></div>
<p>来关注一下 <code>PyFunction_SetClosure</code></p>
<div class="monokai"><pre><span></span><span class="kt">int</span>
<span class="nf">PyFunction_SetClosure</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">closure</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="n">Py_XDECREF</span><span class="p">(((</span><span class="n">PyFunctionObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">op</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">func_closure</span><span class="p">);</span>
    <span class="p">((</span><span class="n">PyFunctionObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">op</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">func_closure</span> <span class="o">=</span> <span class="n">closure</span><span class="p">;</span>  <span class="c1">// 注意这里</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>即<code>do_add</code>的 <code>PyFunctionObject</code>的<code>func_closure</code>指向一个tuple</p>
<p>注意: 这时候, 外层变量已经固定下来了!!!!!!</p>
<h3 id="ran-hou-zai-qian-tao-han-shu-bei-diao-yong-de-shi-hou">然后, 在嵌套函数被调用的时候</h3>
<div class="monokai"><pre><span></span><span class="n">CALL_FUNCTION</span>

<span class="o">=&gt;</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">call_function</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="n">oparg</span><span class="p">);</span>

<span class="o">=&gt;</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">fast_function</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">pp_stack</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">nk</span><span class="p">);</span>

<span class="o">=&gt;</span>

      <span class="k">return</span> <span class="n">PyEval_EvalCodeEx</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span>
                               <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">pp_stack</span><span class="p">)</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span>
                               <span class="p">(</span><span class="o">*</span><span class="n">pp_stack</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span>
                               <span class="n">PyFunction_GET_CLOSURE</span><span class="p">(</span><span class="n">func</span><span class="p">));</span>
</pre></div>
<p>看下<code>PyFunction_GET_CLOSURE</code></p>
<div class="monokai"><pre><span></span>  <span class="cp">#define PyFunction_GET_CLOSURE(func) \</span>
<span class="cp">      (((PyFunctionObject *)func) -&gt; func_closure)</span>
</pre></div>
<p>然后, 进入 <code>PyEval_EvalCodeEx</code>, 注意这里的<code>closure</code>参数即上一步取出来的<code>func_closure</code>, 即外层函数传进来的tuple</p>
<div class="monokai"><pre><span></span>  <span class="n">PyObject</span> <span class="o">*</span>
  <span class="nf">PyEval_EvalCodeEx</span><span class="p">(</span><span class="n">PyCodeObject</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">locals</span><span class="p">,</span>
             <span class="n">PyObject</span> <span class="o">**</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argcount</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">**</span><span class="n">kws</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kwcount</span><span class="p">,</span>
             <span class="n">PyObject</span> <span class="o">**</span><span class="n">defs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">defcount</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">closure</span><span class="p">)</span>
<span class="p">{</span>
      <span class="p">......</span>
      <span class="c1">//  嵌套函数do_add, 使用到了外层函数的变量, 所以co-&gt;co_freevars非空, 这里得到 ('x', )</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_freevars</span><span class="p">))</span> <span class="p">{</span>
          <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_freevars</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
              <span class="c1">// 顺序是一致的</span>
              <span class="n">PyObject</span> <span class="o">*</span><span class="n">o</span> <span class="o">=</span> <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">closure</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
              <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
              <span class="c1">// 放到freevars里面, 编译时已经确定了顺序</span>
              <span class="c1">// 在上一步多LOAD_CLOSURE =&gt; tuple 已经保证了顺序</span>
              <span class="n">freevars</span><span class="p">[</span><span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">co_cellvars</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
      <span class="p">......</span>
</pre></div>
<h3 id="zui-hou-zai-lai-kan-yi-ge-bi-bao-de-dis">最后, 再来看一个闭包的dis</h3>
<p>注意<code>BUILD_TUPLE</code></p>
<div class="monokai"><pre><span></span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">do_add</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">do_add2</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">y</span> <span class="o">+</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">do_add3</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">do_add</span>
</pre></div>
<p>dis结果</p>
<div class="monokai"><pre><span></span> <span class="mi">18</span>           <span class="mi">0</span> <span class="n">LOAD_CLOSURE</span>             <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
              <span class="mi">3</span> <span class="n">BUILD_TUPLE</span>              <span class="mi">1</span>
              <span class="mi">6</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">code</span> <span class="n">object</span> <span class="n">do_add</span> <span class="n">at</span> <span class="mh">0x10560dc30</span><span class="p">,</span> <span class="n">file</span> <span class="s">"a.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">18</span><span class="o">&gt;</span><span class="p">)</span>
              <span class="mi">9</span> <span class="n">MAKE_CLOSURE</span>             <span class="mi">0</span>
             <span class="mi">12</span> <span class="n">STORE_FAST</span>               <span class="mi">2</span> <span class="p">(</span><span class="n">do_add</span><span class="p">)</span>

 <span class="mi">21</span>          <span class="mi">15</span> <span class="n">LOAD_CLOSURE</span>             <span class="mi">1</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>
             <span class="mi">18</span> <span class="n">BUILD_TUPLE</span>              <span class="mi">1</span>
             <span class="mi">21</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">code</span> <span class="n">object</span> <span class="n">do_add2</span> <span class="n">at</span> <span class="mh">0x10560d8b0</span><span class="p">,</span> <span class="n">file</span> <span class="s">"a.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">21</span><span class="o">&gt;</span><span class="p">)</span>
             <span class="mi">24</span> <span class="n">MAKE_CLOSURE</span>             <span class="mi">0</span>
             <span class="mi">27</span> <span class="n">STORE_FAST</span>               <span class="mi">3</span> <span class="p">(</span><span class="n">do_add2</span><span class="p">)</span>

 <span class="mi">24</span>          <span class="mi">30</span> <span class="n">LOAD_CLOSURE</span>             <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
             <span class="mi">33</span> <span class="n">LOAD_CLOSURE</span>             <span class="mi">1</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>
             <span class="mi">36</span> <span class="n">BUILD_TUPLE</span>              <span class="mi">2</span>
             <span class="mi">39</span> <span class="n">LOAD_CONST</span>               <span class="mi">3</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">code</span> <span class="n">object</span> <span class="n">do_add3</span> <span class="n">at</span> <span class="mh">0x10560e3b0</span><span class="p">,</span> <span class="n">file</span> <span class="s">"a.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">24</span><span class="o">&gt;</span><span class="p">)</span>
             <span class="mi">42</span> <span class="n">MAKE_CLOSURE</span>             <span class="mi">0</span>
             <span class="mi">45</span> <span class="n">STORE_FAST</span>               <span class="mi">4</span> <span class="p">(</span><span class="n">do_add3</span><span class="p">)</span>

 <span class="mi">32</span>          <span class="mi">48</span> <span class="n">LOAD_FAST</span>                <span class="mi">2</span> <span class="p">(</span><span class="n">do_add</span><span class="p">)</span>
             <span class="mi">51</span> <span class="n">RETURN_VALUE</span>
</pre></div>
    </section>

    <section id="copyright">
        <div class="copyright">
            版权声明：自由转载-非商用-非衍生-保持署名 | <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank" >Creative Commons BY-NC-ND 3.0</a>
        </div>

        <div class="donation">
            <center>
                <div style="width: 70%;">
                    <img src="/imgs/life/donation_w.png" style=""/>
                    <strong>
                        <div style="text-align:center;">
                            如果我的文章或项目对你有所帮助, 可以扫码进行小额捐赠<br>
                            如果有主机需求, 可点下方vultr进入注册, 带小尾巴:)<br>
                            如果要加广告位, 请邮件联系<br>
                        </ol>
                    </strong>
                </div>
            </center>

        </div>
    </section>


    <section id="neighbors">
        <div>
                        <a class="left" href="http://www.wklken.me/posts/2015/08/29/python-source-memory-2.html">
                            上一篇:  Python源码阅读-内存管理机制(二)
                        </a>
                        <a class="right" href="http://www.wklken.me/posts/2015/09/23/apue-note-chapter-1.html">
                            下一篇: APUE笔记-第一章 UNIX基础知识
                        </a>
        </div>
    </section>

    <section id="ad">
        <!-- <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> -->
        <!-- [> blog_ad_003 <] -->
        <!-- <ins class="adsbygoogle" -->
            <!-- style="display:block" -->
            <!-- data-ad-client="ca-pub-7635941258020589" -->
            <!-- data-ad-slot="7030416955" -->
            <!-- data-ad-format="auto"></ins> -->
        <!-- <script> -->
        <!-- (adsbygoogle = window.adsbygoogle || []).push({}); -->
        <!-- </script> -->

        <a href="https://www.vultr.com/?ref=7825696-4F"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a>
        <a href='http://www.vultr.com/?ref=6847203' target="_blank">
        <img src="/imgs/ads/vultr.png"> </img>
        </a>
    </section>



<section id="comments">
        <div class="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_identifier = "posts/2015/09/04/python-source-closure.html";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://wklken.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            </div>
</section>



</article>
        </section><!--end #main-->

            <footer class="row">
                <div class="large-12 columns">
                    <p>
                            Copyright © 2015 wklken <br>
                            Hosted on <a href="http://www.vultr.com/?ref=6954153-3B"> vultr </a>. Powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Social Icons by <a href="http://fortawesome.github.io/Font-Awesome/">Font-Awesome</a>.
                            <!-- Hosted on <a href="http://www.vultr.com/?ref=6847203"> vultr </a> Also <a href="https://www.digitalocean.com/?refcode=8ee73f2c47ce"> DigitalOcean </a>. Powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Social Icons by <a href="http://fortawesome.github.io/Font-Awesome/">Font-Awesome</a>. -->
                    </p>
                </div>
            </footer>

            </div>
        </div>

        <section id="extras" class="body">
        </section><!-- /#extras -->



<script src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://apps.bdimg.com/libs/jquery-scrollUp/2.1.0/jquery.scrollUp.min.js"></script>
<script src="http://apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script>
    $(function(){
        $.scrollUp({
              scrollText: '', // Text for element, can contain HTML
            });
    });
</script>


<script type="text/javascript">
  /* var Swiftype = window.Swiftype || {}; */
  /* Swiftype.searchSearchFields = { */
    /* "page": ["title^10", "body"] */
  /* }; */

  /* (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){ */
  /* (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t); */
  /* e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e); */
  /* })(window,document,'script','//s.swiftypecdn.com/install/v1/st.js','_st'); */

  /* _st('install','v6K-_DamCeHvwX6z3o2F'); */
</script>



    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-42275748-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>




<div id="share">
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":["mshare","tsina","weixin","douban","meilishuo","mogujie","youdao","sdo","mail","twi","copy","print"],"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"5","bdPos":"right","bdTop":"96.5"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</div>



<script  src="http://www.wklken.me/theme/js/scroll-header.js" type="text/javascript"></script>




</body>
</html>